(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[11],{aac1:function(t,e,i){"use strict";i.r(e);var o=function(){var t=this,e=t.$createElement,i=t._self._c||e;return i("q-page",[i("transition",{attrs:{appear:"","appear-active-class":"animated fadeIn","leave-active-class":"animated fadeOut"}},[i("div",{staticClass:"container sgm"},[i("div",{staticClass:"row q-col-gutter-md items-center"},[i("div",{staticClass:"col-auto"},[i("q-btn",{attrs:{round:"",color:"primary",icon:"mdi-chevron-left",disable:t.loading},on:{click:t.doGoBack}})],1),i("div",{staticClass:"col"}),i("div",{staticClass:"col-auto"},[i("q-btn",{attrs:{round:"",color:"primary",icon:"settings",disable:t.loading},on:{click:function(e){t.$sound.tap(),t.$router.push("/settings")}}})],1),i("div",{staticClass:"col-12"},[i("q-card",{staticClass:"q-pa-md",staticStyle:{"margin-top":"72px"}},[i("div",{staticClass:"row q-col-gutter-md"},[i("div",{staticClass:"col-xs-12 col-sm-4 col-md-3 text-center",staticStyle:{"margin-top":"-72px"}},[i("div",{staticClass:"row q-col-gutter-md"},[i("div",{staticClass:"col-12"},[i("div",{staticClass:"relative-position",staticStyle:{width:"100%","max-width":"208px",margin:"0 auto"}},[i("q-img",{staticClass:"shadow-12",attrs:{src:t.coverSrc,ratio:1,width:"100%"}}),i("q-btn",{staticClass:"absolute-bottom-left",staticStyle:{margin:"8px 8px 8px 8px"},attrs:{round:"",color:"red",icon:"mdi-music",size:"md",disable:t.loading||!t.shareTypeList.includes(t.chartInfo.type)},on:{click:function(e){t.$sound.tap(),t.onSetIndexMusic()}}}),"object"===typeof t.chartInfo.cover?i("q-btn",{directives:[{name:"show",rawName:"v-show",value:t.chartInfo.cover.length>1,expression:"chartInfo.cover.length > 1"}],staticClass:"absolute-top-left",staticStyle:{margin:"30px -12px"},attrs:{round:"",icon:"swap_horiz",color:"primary"},on:{click:function(e){t.coverIndex=t.coverIndex===t.chartInfo.cover.length-1?0:t.coverIndex+1}}}):t._e(),i("q-btn",{staticClass:"absolute-bottom-right",staticStyle:{margin:"8px 8px 8px 8px"},style:"transform: rotate(0deg)",attrs:{round:"",icon:t.isFavorite?"favorite":"favorite_border",color:"pink",size:"md",disable:!t.shareTypeList.includes(t.chartInfo.type)},on:{click:function(e){t.$sound.tap(),t.toggleFavorite()}}})],1)]),i("div",{staticClass:"col-12"},[i("diff-icon-list",{attrs:{diffs:t.chartInfo.difficulty,size:36}})],1)])]),i("div",{staticClass:"col-xs-12 col-sm-8 col-md-9"},[i("div",{staticClass:"row q-col-gutter-sm"},[i("div",{staticClass:"col-xs-12 text-h4"},[t._v(t._s(t.$lang.getInLang(t.$i18n.locale,t.chartInfo.title)))]),i("div",{staticClass:"col-xs-12 text-h5"},[t._v(t._s(t.$lang.getInLang(t.$i18n.locale,t.chartInfo.artist)))]),i("div",{staticClass:"col-xs-12 text-h6"},[t._v(t._s(t.chartInfo.author))])])])])])],1),t.difficulties&&t.difficulties.length>1?i("div",{staticClass:"col-12"},[i("q-btn-toggle",{attrs:{color:"white","text-color":"black","toggle-color":t.difficulty,options:t.difficulties,spread:"","no-caps":"",disable:t.loading},model:{value:t.difficulty,callback:function(e){t.difficulty=e},expression:"difficulty"}})],1):t._e(),i("div",{staticClass:"col-xs-6 col-sm-4"},[i("div",[i("q-btn",{staticClass:"full-width",attrs:{"no-caps":"",color:"blue",label:t.$t("btns.LABEL_PACK"),icon:"mdi-download",disable:t.loading||!t.packTypeList.includes(t.chartInfo.type)},on:{click:t.doPack}})],1)]),i("div",{staticClass:"col-xs-6 col-sm-4"},[i("div",[i("q-btn",{staticClass:"full-width",attrs:{"no-caps":"",color:"yellow",label:t.$t("btns.LABEL_SHARE"),icon:"mdi-share",disable:t.loading||!t.shareTypeList.includes(t.chartInfo.type)},on:{click:t.doShare}})],1)]),i("div",{staticClass:"col-xs-12 col-sm-4"},[i("div",[i("q-btn",{staticClass:"full-width",attrs:{"no-caps":"",color:"green",label:t.$t("btns.LABEL_SELECT_MOD"),icon:"mdi-pencil",disable:t.loading},on:{click:t.selectMod}})],1)]),i("div",{staticClass:"col-12"},[i("div",[i("q-btn",{staticClass:"full-width",attrs:{"no-caps":"",color:t.difficulty,label:t.$t("btns.LABEL_START_GAME"),icon:"mdi-music-clef-treble",disable:t.loading,loading:t.loading},on:{click:t.onStart}},[t.mod&&t.modHelperList[t.mod]&&t.mod.length>0?i("q-badge",{attrs:{color:t.modHelperList[t.mod].color,floating:""}},[t._v("\n                "+t._s(t.modHelperList[t.mod].text)+" mod ON\n              ")]):t._e()],1)],1)])])])])],1)},a=[],s=(i("ddb0"),i("c973")),c=i.n(s),l=i("ded3"),n=i.n(l),r=i("ce39"),d=i("2f62"),f=i("2b0e"),p=i("8847"),h=i("4360");const u={enableMod:(t,e="")=>{switch(e){case"singleDog":t.slides=[],t.notes.forEach(t=>t.type="single");break;case"flickParty":t.slides.forEach(t=>t.flickend=!0),t.notes.forEach(t=>t.type="slide"===t.type?"slide":"flick");break;case"allFlick":t.slides=[],t.notes.forEach(t=>t.type="flick");break;default:break}}};var g=u;function m(t){let e=[],i=[],o=[],a=-1,s=-1,c=[-1,-1,-1,-1,-1,-1,-1],l=(t,e)=>{let i=0;for(let o=0;o<e.length;o++)o===e.length-1?i+=60*(t-e[o].beat)/e[o].bpm:t>e[o+1].beat?i+=60*(e[o+1].beat-e[o].beat)/e[o].bpm:i+=60*(t-e[o].beat)/e[o].bpm;return i};return t.forEach(t=>{switch(t.type){case"System":"BPM"===t.cmd&&e.push(t);break;case"Note":let n={time:l(t.beat,e),lane:t.lane-1,onbeat:t.beat%.5===0};if("Slide"===t.note)if(n.type="slide",t.start){let e={id:o.length,flickend:!1};"A"===t.pos?a=e.id:s=e.id,o.push(e),n.slideid=e.id}else if(t.end){if(n.slideid="A"===t.pos?a:s,-1===n.slideid){n.type=t.flick?"flick":"single";break}t.flick&&(o[n.slideid].flickend=!0),"A"===t.pos?a=-1:s=-1}else n.slideid="A"===t.pos?a:s;else if("Long"===t.note)if(n.type="slide",t.start){let t={id:o.length,flickend:!1};c[n.lane]=t.id,n.slideid=t.id,o.push(t)}else t.end?(n.slideid=c[n.lane],t.flick&&(o[n.slideid].flickend=!0),c[n.lane]=-1):n.slideid=c[n.lane];else n.type=t.flick?"flick":"single";i.push(n);break;default:break}}),{notes:i,slides:o}}function y(t){let e=[],i=[],o={};const a=(t,e)=>{let i=t.time+60/t.bpm*e.offset/48;return i||0};return t.slides.forEach(t=>{o[t.id]=i.length,i.push({id:i.length,flickend:t.flickend})}),t.notes.forEach(i=>{let s;for(let e in t.timepoints)t.timepoints[e].id===i.timepoint&&(s=t.timepoints[e]);let c={time:a(s,i),lane:i.lane,onbeat:i.offset%24===0};"single"===i.type?c.type="single":"flick"===i.type?c.type="flick":(c.type="slide",c.slideid=o[i.slide]),e.push(c)}),{notes:e,slides:i}}function b(t,e){let i=null;if("official"===t.type||"bestdori"===t.type||Array.isArray(e))i=m(e);else if("bangbangboomv2"===t.type||e.timepoints&&e.notes)i=y(e);else{if(!("bbbMapContent"===t.type||e.notes&&e.slides))throw new Error("ERR_UNKNOWN_CHART_TYPE");i=e}return i}function $(t,e,i){return I.apply(this,arguments)}function I(){return I=c()((function*(t,e,i){try{const a={};let s=b(t,e);g.enableMod(s,h["a"].state.mods.mod),a.mapContent=()=>s,a.musicSrc=f["a"].prototype.$settings.usePreferProxyUrl(t.audio),h["a"].commit("downloadDialog/update",{display:!0}),h["a"].commit("downloadDialog/update",{title:p["b"].t("pack.TITLE_DOWNLOAD_RESOURCES")});try{h["a"].commit("downloadDialog/update",{message:p["b"].t("pack.MSG_GETTING_AUDIO")}),a.musicSrc=yield f["a"].prototype.$file.readFile(yield f["a"].prototype.$file.getFile(a.musicSrc),"dataurl")}catch(o){if(f["a"].prototype.$axios.isCancel(o))throw new Error("Canceled")}let c="";return c="object"===typeof t.cover&&t.cover[i]?t.cover[i]:t.cover,a.backgroundSrc=f["a"].prototype.$settings.getBackgroundUrl(c),a.skin="skins/"+f["a"].prototype.$settings.get("skin"),a.sound=f["a"].prototype.$settings.getSoundSrc(),a.songName=f["a"].prototype.$lang.getInLang(p["b"].locale,t.title),a}catch(o){throw o}finally{h["a"].commit("downloadDialog/update",{display:!1})}})),I.apply(this,arguments)}var v=i("cdde"),k=i("7937"),C=i("a357"),_=i("11ec"),w=i("c4e3"),S=i.n(w);const{capitalize:D}=k["c"],E=["official","bestdori","auto"],x=["official","bestdori"];var T={name:"Info",components:{DiffIconList:r["a"]},data:function(){return{coverIndex:0,rotateTimer:null,difficulty:null,loading:!1,packTypeList:E,shareTypeList:x}},computed:n()(n()({chartInfo:{get(){return this.$store.state.chartInfo.chartInfo}},chartData:{get(){return this.$store.state.chartInfo.chartData}},coverSrc:{get(){let t="";return"object"===typeof this.chartInfo.cover?t=this.chartInfo.cover[this.coverIndex]:"string"===typeof this.chartInfo.cover&&(t=this.chartInfo.cover),this.$settings.usePreferProxyUrl(t)}},difficulties:{get(){let t=[];for(const e in this.chartInfo.difficulty)t.push({label:D(this.chartInfo.difficulty[e].type),value:this.chartInfo.difficulty[e].type});return t}}},Object(d["b"])({isFavorite:"favorite/isFavorite"})),{},{mod:{get(){return this.$store.state.mods.mod}},modHelperList:{get(){return this.$store.state.mods.modHelperList||[]}}}),methods:{onStart(){var t=this;return c()((function*(){t.loading=!0,t.$sound.tap();try{let e=null;if("official"===t.chartInfo.type)e=yield t.$bestdori.getOfficialChartData(t.chartInfo.id,t.difficulty);else if("bestdori"===t.chartInfo.type)e=(yield t.$bestdori.getCommunityChartData(t.chartInfo.id)).post.notes;else{if("bangpack"!==t.chartInfo.type&&"auto"!==t.chartInfo.type)throw new Error("ERR_UNKNOWN_CHART_TYPE");e=JSON.parse(JSON.stringify(t.chartData[t.difficulty]))}let i=yield $(t.$store.state.chartInfo.chartInfo,e,t.coverIndex);t.$store.commit("chartInfo/updateGameLoadConfig",i),x.includes(t.chartInfo.type)&&(yield t.$store.commit("favorite/addHistory",t.chartInfo)),t.$audio.fadeOutPause(),t.$audio.setDisable(!0),yield t.$router.push("/game")}catch(e){"Canceled"!==e.message&&t.$q.notify({message:t.$t("public.error"),caption:t.$t(e.message),icon:"mdi-close"})}finally{t.loading=!1}}))()},onSetIndexMusic(){var t=this;return c()((function*(){t.$q.loading.show();try{const e=[],i=0;let o=null;switch(t.chartInfo.type){case"bestdori":o=(yield t.$bestdori.getCommunityChartData(t.chartInfo.id)).post.notes;break;case"official":o=yield t.$bestdori.getOfficialChartData(t.chartInfo.id,"expert");break;default:throw new Error("Unsupported type")}let a={bpm:0,time:0,beat:0};for(const t of o)if("system"===t.type.toLowerCase()&&"bpm"===t.cmd.toLowerCase()){const i={bpm:t.bpm,time:60*(t.beat-a.beat)/a.bpm||0};e.push(i),a=n()(n()({},i),{},{beat:t.beat})}const s=t.$settings.getAll();s.bgm={src:t.chartInfo.audio,cover:t.chartInfo.cover,title:t.chartInfo.title,artist:t.chartInfo.artist,offset:i,timePoints:e},t.$store.commit("settings/updateSettings",s),t.$q.notify({message:t.$i18n.t("public.success"),caption:t.$i18n.t("INFO_SET_INDEX_MUSIC_SUCCESS",[t.$lang.getInLang(t.$i18n.locale,t.chartInfo.title)]),icon:"mdi-check"})}catch(e){t.$q.notify({message:t.$i18n.t("public.error"),caption:t.$i18n.t("ERR_SET_INDEX_MUSIC_FAILED",[t.$lang.getInLang(t.$i18n.locale,t.chartInfo.title)]),icon:"mdi-close"})}t.$q.loading.hide()}))()},setBtnRotate(){this.$refs.audioController&&(this.$refs.audioController.style.transform=`rotate(${10*-this.$audio.currentTime()}deg)`)},toggleFavorite(){this.$store.commit("favorite/toggleFavorite",this.chartInfo)},doGoBack(){var t=this;return c()((function*(){switch(t.$sound.tap(),t.chartInfo.type){case"bestdori":yield t.$router.push("/bestdori");break;case"official":yield t.$router.push("/official");break;case"local":yield t.$router.push("/local");break;default:yield t.$router.push("/")}}))()},selectMod(){this.$q.bottomSheet({message:this.$t("mods.title"),actions:[{label:"None",id:"none",icon:"mdi-cancel"},{label:"Single Dog",id:"singleDog",icon:"img: img/singleDog.png"},{label:"Flick Party!",id:"flickParty",icon:"img: img/flickParty.png"},{label:"All Flick",id:"allFlick",icon:"img: img/allFlick.png"}]}).onOk(t=>{this.$store.commit("mods/updateMod",t.id)})},doPack(){var t=this;return c()((function*(){t.$store.commit("downloadDialog/update",{display:!0}),t.$store.commit("updateDownloadInfo",{startAt:0,lastUpdate:0,currentSize:0,totalSize:0,totalTime:0,downloadSpeed:0,averageSpeed:0,progress:0,finished:!1});try{t.$store.commit("downloadDialog/update",{title:t.$t("pack.TITLE_DOWNLOAD_CHART_DATA")});const e={};if("official"===t.chartInfo.type)for(const r of t.chartInfo.difficulty){t.$store.commit("downloadDialog/update",{message:t.$t("pack.MSG_GETTING_CHART_DATA",[r.type])});const i=yield t.$bestdori.getOfficialChartData(t.chartInfo.id,r.type);e[r.type]=b(t.chartInfo,i)}else if("bestdori"===t.chartInfo.type)for(const r of t.chartInfo.difficulty){t.$store.commit("downloadDialog/update",{message:t.$t("pack.MSG_GETTING_CHART_DATA",[r.type])});const i=(yield t.$bestdori.getCommunityChartData(t.chartInfo.id)).post.notes;e[r.type]=b(t.chartInfo,i)}else{if("auto"!==t.chartInfo.type)throw new Error("ERR_UNKNOWN_CHART_TYPE");for(const i of t.chartInfo.difficulty)e[i.type]=b(t.chartInfo,t.chartData[i.type])}let i;t.$store.commit("downloadDialog/update",{title:t.$t("pack.TITLE_DOWNLOAD_RESOURCES")}),i="auto"===t.chartInfo.type?`${t.chartInfo.artist} - ${t.chartInfo.title}.bangpack`:`[${t.chartInfo.id}]${t.$lang.getInLang(t.$i18n.locale,t.chartInfo.artist)} - ${t.$lang.getInLang(t.$i18n.locale,t.chartInfo.title)}.bangpack`;const o=t.$settings.usePreferProxyUrl(t.chartInfo.audio,!0),a=t.$settings.usePreferProxyUrl("object"===typeof t.chartInfo.cover?t.chartInfo.cover[0]:t.chartInfo.cover,!0);t.$store.commit("downloadDialog/update",{message:t.$t("pack.MSG_GETTING_AUDIO")});const s=yield t.$file.getFile(o);t.$store.commit("downloadDialog/update",{message:t.$t("pack.MSG_GETTING_COVER")});const c=yield t.$file.getFile(a);let l;l=Object(_["a"])(!0,l,t.chartInfo),t.$delete(l,"audio"),t.$delete(l,"cover");const n=new S.a;n.file("audio",s,{binary:!0}),n.file("cover",c,{binary:!0}),n.file("chart.json",JSON.stringify({chartInfo:l,chartData:e})),yield n.generateAsync({type:"blob"}).then((function(t){Object(C["a"])(i,t,"application/zip")}))}catch(e){console.log(e)}finally{t.$store.commit("downloadDialog/clear")}}))()},doShare(){const t=`https://bangplayer.live/${this.chartInfo.type}/${this.chartInfo.id}`;Object(v["a"])(t).then(()=>{this.$q.notify({message:this.$t("public.success"),caption:this.$t("INFO_COPY_TO_CLIPBOARD_SUCCESS"),icon:"mdi-check"})}).catch(()=>{this.$q.notify({message:this.$t("public.failed"),caption:this.$t("INFO_COPY_TO_CLIPBOARD_FAILED"),icon:"mdi-close"}),this.$q.dialog({title:this.$t("TITLE_COPY_SHARE_LINK"),message:`<div class="text-center full-width q-pa-sm" style="border: 3px dashed grey">${t}</div>`,html:!0})})}},mounted(){var t=this;return c()((function*(){t.difficulty=t.difficulties[t.difficulties.length-1].value,t.chartInfo.audio!==t.$settings.get("bgm").src&&t.$audio.changeAudioWithFadeOut(t.$settings.usePreferProxyUrl(t.chartInfo.audio),()=>{t.$audio.cover=t.$settings.usePreferProxyUrl("object"===typeof t.chartInfo.cover?t.chartInfo.cover[0]:t.chartInfo.cover),t.$audio.title=t.$lang.getInLang(t.$i18n.locale,t.chartInfo.title),t.$audio.artist=t.$lang.getInLang(t.$i18n.locale,t.chartInfo.artist)}),t.$store.commit("favorite/updateFavorite",t.chartInfo)}))()},beforeDestroy(){var t=this;return c()((function*(){t.$store.commit("downloadDialog/clear"),t.chartInfo.audio!==t.$settings.get("bgm").src&&t.$audio.fadeOutPause(()=>{t.$audio.setDefaultAudio(),t.$audio.play()})}))()}},L=T,A=i("2877"),O=i("9989"),P=i("9c40"),N=i("f09f"),q=i("068f"),R=i("0d59"),F=i("6a67"),U=i("58a8"),G=i("eebe"),M=i.n(G),B=Object(A["a"])(L,o,a,!1,null,null,null);e["default"]=B.exports;M()(B,"components",{QPage:O["a"],QBtn:P["a"],QCard:N["a"],QImg:q["a"],QSpinner:R["a"],QBtnToggle:F["a"],QBadge:U["a"]})}}]);